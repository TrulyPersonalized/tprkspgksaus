<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Generation System | Truly Personalized</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/qr-code-styling/lib/qr-code-styling.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <link href="https://fonts.googleapis.com/css?family=Raleway:400,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fff5eb;
            --primary: #ed4167;
            --accent: #ffa700;
            --secondary: #96ded5;
            --card-bg: #fff;
            --text: #222;
            --muted: #666;
            --credit: #4CAF50;
            --debit: #F44336;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Raleway', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background-color: var(--secondary);
            color: white;
            padding: 16px 32px 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px var(--primary)33;
            position: relative;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-img {
            width: 100px;
            height: 100%;
            border-radius: 10px;
            background: var(--secondary);
            object-fit: cover;
            box-shadow: 0 2px 10px var(--secondary)80;
        }
        .header-title { font-size: 1.55rem; font-weight: 700; letter-spacing: 0.02em; }
        .add-order-btn {
            background-color: black;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 60px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 2px 8px var(--accent)33;
            transition: background 0.22s, color 0.22s;
        }
        .add-order-btn:hover { background-color: var(--primary); color: #fff; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .form-container {
            width: 410px;
            background: var(--bg);
            padding: 32px 26px 26px 26px;
            border-right: 2px solid var(--secondary);
            overflow-y: auto;
            transition: transform 0.3s;
            transform: translateX(-100%);
            position: absolute;
            height: calc(100vh - 64px);
            z-index: 10;
            box-shadow: 2px 0 18px var(--primary)11;
        }
        .form-container.show { transform: translateX(0); }
        .form-close-btn {
            position: absolute;
            top: 18px;
            right: 22px;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 2rem;
            cursor: pointer;
            z-index: 999;
            transition: color 0.2s;
        }
        .form-close-btn:hover { color: var(--accent);}
        .order-list-container { flex: 1; padding: 32px 28px; overflow-y: auto; }
        h1 { margin-bottom: 28px; color: var(--primary); font-size: 1.4rem; font-weight: 700; letter-spacing: 0.02em;}
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--primary);}
        input[type="text"], input[type="number"], textarea, select, input[type="tel"], input[type="email"] {
            width: 100%; padding: 11px; border: 1px solid var(--secondary);
            border-radius: 60px; font-size: 15px; background: var(--bg);
            transition: border-color 0.18s;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, input[type="tel"]:focus, input[type="email"]:focus {
            border-color: var(--accent);
            outline: none;
        }
        textarea { height: 87px; resize: vertical; border-radius: 30px; padding: 15px;}
        .order-id {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 0.04em;
        }
        .form-actions { display: flex; gap: 10px; }
        .form-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 60px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.22s;
            font-weight: 700;
        }
        .save-btn { background-color: var(--primary); color: white; border: none; }
        .save-btn:hover { background-color: var(--accent); color: var(--primary); }
        .hidden { display: none; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg);
            box-shadow: 0 0 14px var(--primary)15;
            font-size: 14px;
            border-radius: 10px;
            overflow: hidden;
        }
        th{ padding: 8px 10px; text-align: left; }
td{ padding-left:10px;
padding-right:10px;
text-align: left;}
        th {
            background-color: var(--secondary);
            font-weight: 700;
            position: sticky;
            top: 0;
            font-size: 12px;
            color: black;
        }
/* FULL BILL LAYOUT – EXACT MATCH TO YOUR GIVEN DESIGN */

#bill-export {
    max-width: 1587px;
    width: 1587px;
    margin: 0 auto;
    position: relative;
    background: #fff5eb;
    font-family: 'Josefin Sans', sans-serif;
    padding-top: 160px;     /* space for top border */
    padding-bottom: 160px;  /* space for bottom border */
}


/* TOP IMAGE */
.bill-top-img {
    width: 100%;
    display: block;
    margin: 0;
    padding: 0;
}

/* BOTTOM IMAGE */
.bill-bottom-img {
    width: 100%;
    display: block;
    margin: 0;
    padding: 0;
}

/* LEFT BORDER */
.bill-left {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 120px;
    background: url('border.png') repeat-y;
    background-size: cover;
}

/* RIGHT BORDER */
.bill-right {
    position: absolute;
    top: 0;
    bottom: 0;
    right: 0;
    width: 120px;
    background: url('border.png') repeat-y;
    background-size: cover;
}


/* CONTENT AREA */
#bill-export .bill-body {
    padding: 60px 180px;  /* matches your actual bill layout spacing */
}

/* TITLE */
#bill-export .bill-title {
    font-size: 48px;
    font-weight: 700;
    text-align: center;
    margin: 0;
    padding: 0;
}

/* LINE DIVIDER */
#bill-export .bill-line {
    width: 100%;
    margin: 40px 0;
}

/* CUSTOMER DETAILS */
#bill-export .bill-info {
    font-size: 38px;
    line-height: 1.4;
}

/* PRODUCT TABLE */
#bill-export table.bill-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 34px;
    line-height: 1.35;
}



#bill-export table.bill-table th,
#bill-export table.bill-table td {
    padding: 12px 0;
}



/* TOTALS SECTION */
#bill-export table.bill-totals {
    width: 60%;
    font-size: 38px;
    line-height: 1.4;
    margin-top: 20px;
}

/* FOOTER TEXT */
#bill-export .bill-footer {
    text-align: center;
    font-size: 32px;
    margin-top: 60px;
}

        tr:hover { background-color: var(--bg); }
        .action-icons { display: flex; gap: 10px; }
        .action-icon { cursor: pointer; font-size: 16px; transition: color 0.2s; }
        .edit-icon { color: var(--accent);}
        .edit-icon:hover { color: var(--primary);}
        .delete-icon { color: var(--primary);}
        .delete-icon:hover { color: var(--accent);}
        .no-orders { text-align: center; padding: 44px; color: var(--muted); font-size: 1.1rem;}
        .customer-info {
            border: 1px solid var(--secondary);
            border-radius: 30px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--bg);
        }
        .customer-info h4 { margin-bottom: 10px; color: var(--primary);}
        .address-dropdown {
            width: 100%;
            padding: 8px;
            border-radius: 30px;
            border: 1px solid var(--secondary);
            margin-bottom: 10px;
        }
        .product-row {
            border: 1px solid var(--secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .product-line {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .product-line:last-child {
            margin-bottom: 0;
        }
        .product-line input, .product-line select {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--secondary);
            border-radius: 30px;
        }
        .product-line .short-input {
            flex: 0.5;
        }
        .delivery-type {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .delivery-type label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text);
        }
        .delivery-type input[type="radio"] { margin: 0; width: auto; }

        /* Add this new style for delivery reason */
        .delivery-reason {
            width: 100%;
            margin-top: 10px;
        }

        .remove-product-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .add-product-btn {
            background: var(--secondary);
            color: var(--text);
            border: none;
            border-radius: 60px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
        }
        .add-product-btn:hover {
            background: var(--primary);
            color: white;
        }
        .summary-section {
            border: 1px solid var(--secondary);
            border-radius: 30px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--bg);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .summary-total {
            font-weight: bold;
            border-top: 1px solid var(--secondary);
            padding-top: 8px;
            margin-top: 8px;
        }
        .coupon-section {
            border: 1px solid var(--secondary);
            border-radius: 30px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--bg);
        }
        .coupon-item {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--secondary);
        }
        .coupon-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .coupon-name {
            font-weight: bold;
            color: var(--primary);
        }
        .coupon-value {
            font-weight: bold;
            color: var(--credit);
        }
        .remove-coupon {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--primary);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: all 0.3s ease;
            max-width: 300px;
        }
        .notification-hidden {
            transform: translateX(100%);
            opacity: 0;
            visibility: hidden;
        }
        .notification-visible {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification-content i {
            font-size: 1.2rem;
        }
        .search-and-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .search-bar-wrapper {
            flex: 1;
            position: relative;
        }
        .search-x-btn {
            position: absolute;
            right: 8px;
            top: 12px;
            background: none;
            border: none;
            font-size: 22px;
            color: var(--primary);
            cursor: pointer;
            padding: 0 6px;
            z-index: 2;
            display: none;
        }
        .loss-indicator {
            color: var(--debit);
            font-weight: bold;
            font-size: 12px;
            margin-top: 5px;
        }
        @media (max-width: 900px) {
            .main-container { flex-direction: column; }
            .form-container { width: 100vw; position: fixed; left: 0; top: 0; height: 100vh; z-index: 20;}
            .order-list-container { padding: 18px 8px; }
            table { font-size: 12px;}
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">
            <img class="logo-img" src="tp.png" alt="Logo">
            <span class="header-title">Order Generation System</span>
        </div>
        <button id="showFormBtn" class="add-order-btn">
            <i class="fas fa-plus"></i> Create Order
        </button>
    </header>
    <div class="main-container">
        <div id="orderFormContainer" class="form-container">
            <button type="button" id="formCloseBtn" class="form-close-btn" title="Close">&times;</button>
            <h1>Create New Order</h1>
            <div class="order-id" id="orderIdDisplay">
                Generating Order ID...
            </div>
            <form id="orderForm">
                <div class="customer-info">
                    <h4>Customer Information</h4>
                    <div class="form-group">
                        <label for="customerMobile">Mobile Number</label>
                        <input type="tel" id="customerMobile" name="customerMobile" placeholder="10-digit mobile number" list="customerMobiles">
                        <datalist id="customerMobiles"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="customerInsta">Instagram ID</label>
                        <input type="text" id="customerInsta" name="customerInsta" placeholder="Instagram username (optional)" list="customerInstas">
                        <datalist id="customerInstas"></datalist>
                    </div>
                    <div id="customerDetails" class="hidden">
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" name="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email (optional)</label>
                            <input type="email" id="customerEmail" name="customerEmail" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <select id="customerAddressDropdown" name="customerAddressDropdown" class="address-dropdown hidden">
                                <option value="">Select saved address</option>
                            </select>
                            <textarea id="customerAddress" name="customerAddress" placeholder="Full address" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="customerWallet">Wallet Balance</label>
                            <input type="number" id="customerWallet" name="customerWallet" readonly>
                            <div id="walletApplySection" class="hidden" style="margin-top: 10px;">
                                <label>
                                    <input type="checkbox" id="applyWallet" name="applyWallet"> Apply 10% of order value from wallet
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="products-section">
                    <h4>Products</h4>
                    <div id="productsContainer">
                        <!-- Product rows will be added here -->
                    </div>
                    <button type="button" id="addProductBtn" class="add-product-btn">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>

                <div class="form-group">
                    <label for="orderExtraAmount">Order Extra Amount</label>
                    <div style="display:flex;gap:10px;">
                        <select id="orderExtraType" style="width: 60px;">
                            <option value="+">+</option>
                            <option value="-">-</option>
                        </select>
                        <input type="number" id="orderExtraAmount" name="orderExtraAmount" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="deliveryAmountInput">Delivery Charges (editable)</label>
                    <input type="number" id="deliveryAmountInput" name="deliveryAmountInput" value="60">
                </div>

                <div class="coupon-section">
                    <h4>Coupons & Discounts</h4>
                    <div id="availableCoupons" class="hidden">
                        <label>Available Coupons:</label>
                        <select id="couponDropdown" name="couponDropdown" class="address-dropdown">
                            <option value="">Select a coupon</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="couponCode">Coupon Code (optional)</label>
                        <input type="text" id="couponCode" name="couponCode" placeholder="Enter coupon code">
                    </div>
                    <div class="form-group">
                        <label for="couponName">Coupon Name</label>
                        <input type="text" id="couponName" name="couponName" placeholder="Coupon Name">
                    </div>
                    <div id="couponUsedNotice" style="display:none;color:red;"></div>
                    <div class="form-group">
                        <label for="couponValue">Discount Value</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="couponValue" name="couponValue" placeholder="Amount" style="flex: 1;">
                            <select id="couponType" name="couponType" style="width: 100px;">
                                <option value="amount">₹</option>
                                <option value="percent">%</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="couponProductId">Apply to Product ID (optional)</label>
                        <input type="text" id="couponProductId" name="couponProductId" placeholder="Leave blank for order-wide discount">
                    </div>
                    <button type="button" id="addCouponBtn" class="add-product-btn">
                        <i class="fas fa-plus"></i> Add Coupon
                    </button>
                    <div id="appliedCoupons">
                        <!-- Applied coupons will be shown here -->
                    </div>
                </div>

                <div class="summary-section">
                    <h4>Order Summary</h4>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotalAmount">₹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery:</span>
                        <span id="deliveryAmount">₹0.00</span>
                    </div>
                    <div class="summary-row" id="discountRow" style="display: none;">
                        <span>Discount:</span>
                        <span id="discountAmount">-₹0.00</span>
                    </div>
                    <div class="summary-row" id="couponNameRow" style="display: none;">
                        <span>Coupon Name:</span>
                        <span id="couponNameDisplay">-</span>
                    </div>
                    <div class="summary-row" id="walletRow" style="display: none;">
                        <span>Wallet Used:</span>
                        <span id="walletAmount">-₹0.00</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Total:</span>
                        <span id="totalAmount">₹0.00</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="save-btn">Create Order</button>
                </div>
            </form>
        </div>
        <div class="order-list-container">
            <h1>Order History</h1>
            <div class="search-and-actions">
                <div class="search-bar-wrapper">
                    <input type="text" id="searchInput" name="searchInput" placeholder="Search orders by ID, customer, or product..." style="width: 100%; padding: 12px; border: 1px solid var(--secondary); border-radius: 60px; font-size: 16px;">
                    <button id="searchXBtn" class="search-x-btn" title="Clear Search">&times;</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Mobile</th>
                            <th>Products</th>
                            <th>Subtotal</th>
                            <th>Delivery</th>
                            <th>Discount</th>
                            <th>Coupon Name</th>
                            <th>Wallet Used</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <!-- Orders will be added here -->
                    </tbody>
                </table>
            </div>
            <div id="noOrdersMessage" class="no-orders">
                No orders found. Click "Create Order" to start.
            </div>
        </div>
    </div>
    <div id="notification" class="notification-hidden">
        <div class="notification-content"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const showFormBtn = document.getElementById('showFormBtn');
            const formCloseBtn = document.getElementById('formCloseBtn');
            const orderFormContainer = document.getElementById('orderFormContainer');
            const orderForm = document.getElementById('orderForm');
            const orderTableBody = document.getElementById('orderTableBody');
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            const orderIdDisplay = document.getElementById('orderIdDisplay');
            const customerMobile = document.getElementById('customerMobile');
            const customerInsta = document.getElementById('customerInsta');
            const customerMobiles = document.getElementById('customerMobiles');
            const customerInstas = document.getElementById('customerInstas');
            const customerDetails = document.getElementById('customerDetails');
            const customerName = document.getElementById('customerName');
            const customerEmail = document.getElementById('customerEmail');
            const customerAddress = document.getElementById('customerAddress');
            const customerAddressDropdown = document.getElementById('customerAddressDropdown');
            const customerWallet = document.getElementById('customerWallet');
            const walletApplySection = document.getElementById('walletApplySection');
            const applyWallet = document.getElementById('applyWallet');
            const productsContainer = document.getElementById('productsContainer');
            const addProductBtn = document.getElementById('addProductBtn');
            const availableCoupons = document.getElementById('availableCoupons');
            const couponDropdown = document.getElementById('couponDropdown');
            const couponCode = document.getElementById('couponCode');
            const couponName = document.getElementById('couponName');
            const couponValue = document.getElementById('couponValue');
            const couponType = document.getElementById('couponType');
            const couponProductId = document.getElementById('couponProductId');
            const addCouponBtn = document.getElementById('addCouponBtn');
            const appliedCoupons = document.getElementById('appliedCoupons');
            const subtotalAmount = document.getElementById('subtotalAmount');
            const deliveryAmount = document.getElementById('deliveryAmount');
            const deliveryAmountInput = document.getElementById('deliveryAmountInput');
            const discountRow = document.getElementById('discountRow');
            const discountAmount = document.getElementById('discountAmount');
            const couponNameRow = document.getElementById('couponNameRow');
            const couponNameDisplay = document.getElementById('couponNameDisplay');
            const walletRow = document.getElementById('walletRow');
            const walletAmount = document.getElementById('walletAmount');
            const totalAmount = document.getElementById('totalAmount');
            const searchInput = document.getElementById('searchInput');
            const searchXBtn = document.getElementById('searchXBtn');
            const notification = document.getElementById('notification');
            const orderExtraType = document.getElementById('orderExtraType');
            const orderExtraAmount = document.getElementById('orderExtraAmount');
            const couponUsedNotice = document.getElementById('couponUsedNotice');

            // State
            let currentOrderId = '';
            let currentCustomer = null;
            let appliedCouponsList = [];
            let editingOrderId = null;

            // Helper: Generate Order ID
            function generateOrderId() {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = String(now.getFullYear()).slice(-2);
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                currentOrderId = `US${day}${month}${year}${randomNum}`;
                orderIdDisplay.textContent = currentOrderId;
            }

            // Helper: Show Notification
            function showNotification(message, isSuccess = true) {
                const content = notification.querySelector('.notification-content');
                content.innerHTML = `
                    <i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                notification.classList.remove('notification-hidden');
                notification.classList.add('notification-visible');
                setTimeout(() => {
                    notification.classList.remove('notification-visible');
                    notification.classList.add('notification-hidden');
                }, 3000);
            }

            // Helper: Update Customer Datalists
            function updateCustomerDatalists() {
                const customers = JSON.parse(localStorage.getItem('customers')) || [];
                customerMobiles.innerHTML = '';
                customerInstas.innerHTML = '';
                customers.forEach(c => {
                    if (c.mobile) {
                        const opt = document.createElement('option');
                        opt.value = c.mobile;
                        customerMobiles.appendChild(opt);
                    }
                    if (c.insta) {
                        const opt = document.createElement('option');
                        opt.value = c.insta;
                        customerInstas.appendChild(opt);
                    }
                });
            }

            // Helper: Auto-fill customer info
            function autoFillCustomer() {
                const mobile = customerMobile.value.trim();
                const insta = customerInsta.value.trim();
                const customers = JSON.parse(localStorage.getItem('customers')) || [];
                let foundCustomer = null;
                if (mobile) {
                    foundCustomer = customers.find(c => c.mobile === mobile);
                } else if (insta) {
                    foundCustomer = customers.find(c => c.insta && c.insta.toLowerCase() === insta.toLowerCase());
                }
                if (foundCustomer) {
                    currentCustomer = foundCustomer;
                    customerName.value = foundCustomer.name || '';
                    customerEmail.value = foundCustomer.email || '';
                    customerAddressDropdown.innerHTML = '<option value="">Select saved address</option>';
                    if (foundCustomer.addresses && foundCustomer.addresses.length > 0) {
                        foundCustomer.addresses.forEach((addr, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = addr;
                            customerAddressDropdown.appendChild(option);
                        });
                        customerAddressDropdown.classList.remove('hidden');
                    } else {
                        customerAddressDropdown.classList.add('hidden');
                    }
                    customerWallet.value = foundCustomer.walletBalance || 0;
                    if (foundCustomer.walletBalance > 0) {
                        walletApplySection.classList.remove('hidden');
                    } else {
                        walletApplySection.classList.add('hidden');
                    }
                    availableCoupons.classList.remove('hidden');
                    couponDropdown.innerHTML = '<option value="">Select a coupon</option>';
                    if (foundCustomer.coupons && foundCustomer.coupons.length > 0) {
                        foundCustomer.coupons.forEach(coupon => {
                            const option = document.createElement('option');
                            option.value = coupon.id;
                            option.textContent = `${coupon.name || 'Coupon'} (${coupon.value}${coupon.type === 'percent' ? '%' : '₹'})`;
                            couponDropdown.appendChild(option);
                        });
                    }
                    customerDetails.classList.remove('hidden');
                } else {
                    currentCustomer = null;
                    customerName.value = '';
                    customerEmail.value = '';
                    customerAddress.value = '';
                    customerWallet.value = '0';
                    walletApplySection.classList.add('hidden');
                    availableCoupons.classList.add('hidden');
                    customerAddressDropdown.classList.add('hidden');
                    customerDetails.classList.remove('hidden');
                }
            }

            customerMobile.addEventListener('input', autoFillCustomer);
            customerInsta.addEventListener('input', autoFillCustomer);

            customerAddressDropdown.addEventListener('change', function() {
                if (this.value && currentCustomer && currentCustomer.addresses) {
                    customerAddress.value = currentCustomer.addresses[this.value];
                }
            });

            // Add Product Row
            addProductBtn.addEventListener('click', function() {
                addProductRow();
            });

            function addProductRow(productData = {}) {
                const row = document.createElement('div');
                row.className = 'product-row';
                row.innerHTML = `
                    <div class="product-line">
                        <input type="text" class="product-id-input" value="${productData.id || ''}" placeholder="Product ID" list="productIds">
                        <input type="number" class="product-price" min="0" step="0.01" value="${productData.price || ''}" placeholder="Price">
                    </div>
                    <div class="product-line">
                        <input type="text" class="product-name" value="${productData.name || ''}" placeholder="Product Name">
                        <input type="number" class="product-qty short-input" min="1" value="${productData.qty || 1}" placeholder="Qty">
                    </div>
                    <div class="product-line">
                        <select class="delivery-type-select short-input">
                            <option value="RK" ${productData.deliveryType === 'RK' ? 'selected' : ''}>RK</option>
                            <option value="SP" ${productData.deliveryType === 'SP' ? 'selected' : ''}>SP</option>
                            <option value="GK" ${productData.deliveryType === 'GK' ? 'selected' : ''}>GK</option>
                        </select>
                        <input type="number" class="delivery-price" min="0" step="0.01" value="${productData.deliveryPrice || 0}" placeholder="Delivery Price">
                    </div>
                    <div class="product-line">
                        <input type="text" class="delivery-reason" value="${productData.deliveryReason || ''}" placeholder="Delivery price reason (optional)">
                        <select class="product-extra-type short-input">
                            <option value="+" ${productData.extra >= 0 ? 'selected' : ''}>+</option>
                            <option value="-" ${productData.extra < 0 ? 'selected' : ''}>-</option>
                        </select>
                        <input type="number" class="product-extra" min="0" step="0.01" value="${productData.extra ? Math.abs(productData.extra) : 0}" placeholder="Extra Amount">
                    </div>
                    <div class="product-line">
                        <input type="text" class="extra-reason" value="${productData.extraReason || ''}" placeholder="Extra amount reason (optional)">
                        <div class="product-total" style="font-weight: bold; padding: 8px;">₹0.00</div>
                        <button type="button" class="remove-product-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="loss-indicator" style="display: none;"></div>
                `;
                productsContainer.appendChild(row);

                // Datalist for Product IDs
                updateProductIdsDatalist();

                // Listeners
                const productIdInput = row.querySelector('.product-id-input');
                const productNameInput = row.querySelector('.product-name');
                const productPriceInput = row.querySelector('.product-price');
                const productQtyInput = row.querySelector('.product-qty');
                const deliveryTypeSelect = row.querySelector('.delivery-type-select');
                const deliveryPriceInput = row.querySelector('.delivery-price');
                const deliveryReasonInput = row.querySelector('.delivery-reason');
                const productExtraInput = row.querySelector('.product-extra');
                const productExtraType = row.querySelector('.product-extra-type');
                const extraReasonInput = row.querySelector('.extra-reason');
                const removeBtn = row.querySelector('.remove-product-btn');
                const lossIndicator = row.querySelector('.loss-indicator');

                // Set initial delivery price based on type
                function updateDeliveryPrice() {
                    const type = deliveryTypeSelect.value;
                    if (type === 'SP' || type === 'GK') {
                        deliveryPriceInput.value = 0;
                        deliveryPriceInput.readOnly = true;
                    } else {
                        deliveryPriceInput.readOnly = false;
                        if (!productData.deliveryPrice) {
                            deliveryPriceInput.value = 60; // Default RK delivery price
                        }
                    }
                }

                deliveryTypeSelect.addEventListener('change', function() {
                    updateDeliveryPrice();
                    calculateRowTotal(row);
                    updateOrderSummary();
                });

                // Initialize delivery price
                updateDeliveryPrice();

                productIdInput.addEventListener('change', function() {
                    const product = getProductById(this.value);
                    if (product) {
                        productNameInput.value = product.name;
                        productPriceInput.value = product.sellingPrice;
                        calculateRowTotal(row);
                        updateOrderSummary();
                    } else {
                        productNameInput.value = '';
                        productPriceInput.value = '';
                    }
                });

                // Check for loss when price changes
                productPriceInput.addEventListener('input', function() {
                    const product = getProductById(productIdInput.value);
                    if (product) {
                        const currentPrice = parseFloat(this.value) || 0;
                        const sellingPrice = parseFloat(product.sellingPrice) || 0;
                        if (currentPrice < sellingPrice) {
                            const loss = (sellingPrice - currentPrice) * (parseInt(productQtyInput.value) || 1);
                            lossIndicator.textContent = `Loss: ₹${loss.toFixed(2)}`;
                            lossIndicator.style.display = 'block';
                        } else {
                            lossIndicator.style.display = 'none';
                        }
                    }
                    calculateRowTotal(row);
                    updateOrderSummary();
                });

                [productQtyInput, deliveryPriceInput, productExtraInput, productExtraType, extraReasonInput, deliveryReasonInput].forEach(input => {
                    input.addEventListener('input', function() {
                        if (input === productQtyInput && productPriceInput.value) {
                            productPriceInput.dispatchEvent(new Event('input'));
                        } else {
                            calculateRowTotal(row);
                            updateOrderSummary();
                        }
                    });
                });

                removeBtn.addEventListener('click', function() {
                    row.remove();
                    updateOrderSummary();
                });

                if (productData.id) productIdInput.dispatchEvent(new Event('change'));
                if (productData.extraReason) extraReasonInput.value = productData.extraReason;

                calculateRowTotal(row);
                return row;
            }

            // Product Datalist
            function updateProductIdsDatalist() {
                const allProducts = JSON.parse(localStorage.getItem('products')) || [];
                let datalist = document.getElementById('productIds');
                if (!datalist) {
                    datalist = document.createElement('datalist');
                    datalist.id = 'productIds';
                    document.body.appendChild(datalist);
                }
                datalist.innerHTML = '';
                allProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.code;
                    option.textContent = `${product.name} (${product.code})`;
                    datalist.appendChild(option);
                });
            }

            // Product Lookup
            function getProductById(id) {
                const allProducts = JSON.parse(localStorage.getItem('products')) || [];
                return allProducts.find(p => p.code === id);
            }

            // Calculate Product Row Total
            function calculateRowTotal(row) {
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                const qty = parseInt(row.querySelector('.product-qty').value) || 0;
                const deliveryPrice = parseFloat(row.querySelector('.delivery-price').value) || 0;
                const extra = parseFloat(row.querySelector('.product-extra').value) || 0;
                const extraType = row.querySelector('.product-extra-type').value;
                const extraApplied = extraType === '+' ? extra : -extra;
                const total = (price * qty) + (deliveryPrice * qty) + extraApplied;
                row.querySelector('.product-total').textContent = `₹${total.toFixed(2)}`;
                return total;
            }

            // Add Coupon
            addCouponBtn.addEventListener('click', function() {
                const code = couponCode.value.trim();
                const value = parseFloat(couponValue.value) || 0;
                const type = couponType.value;
                const productId = couponProductId.value.trim();
                const nameVal = couponName.value.trim();
                if (value <= 0) {
                    showNotification('Please enter a valid coupon value', false);
                    return;
                }
                let couponUsed = false;
                if (currentCustomer) {
                    const orders = JSON.parse(localStorage.getItem('orders')) || [];
                    const used = orders.some(o => o.customer.mobile === currentCustomer.mobile && o.coupons && o.coupons.some(c => c.id === code));
                    couponUsed = used;
                }
                couponUsedNotice.style.display = couponUsed ? "block" : "none";
                couponUsedNotice.textContent = couponUsed ? "This coupon has already been used by this customer!" : "";
                const coupon = {
                    id: code || `CPN-${Math.random().toString(36).substr(2, 8)}`,
                    name: nameVal || code || 'Manual Discount',
                    value: value,
                    type: type,
                    productId: productId
                };
                appliedCouponsList.push(coupon);
                renderAppliedCoupons();
                updateOrderSummary();
                couponCode.value = '';
                couponValue.value = '';
                couponProductId.value = '';
                couponName.value = '';
                showNotification('Coupon added successfully!');
            });

            // Coupon dropdown change
            couponDropdown.addEventListener('change', function() {
                if (this.value && currentCustomer) {
                    const coupon = currentCustomer.coupons.find(c => c.id === this.value);
                    if (coupon) {
                        couponCode.value = coupon.id;
                        couponValue.value = coupon.value;
                        couponType.value = coupon.type;
                        couponProductId.value = '';
                        couponName.value = coupon.name || coupon.id;
                    }
                }
            });

            // Applied coupons
            function renderAppliedCoupons() {
                appliedCoupons.innerHTML = '';
                if (appliedCouponsList.length === 0) return;
                appliedCouponsList.forEach((coupon, index) => {
                    const item = document.createElement('div');
                    item.className = 'coupon-item';
                    item.innerHTML = `
                        <div class="coupon-header">
                            <span class="coupon-name">${coupon.name}</span>
                            <span class="coupon-value">${coupon.value}${coupon.type === 'percent' ? '%' : '₹'}</span>
                        </div>
                        ${coupon.productId ? `<div>Applied to: ${coupon.productId}</div>` : ''}
                        <button class="remove-coupon" data-index="${index}">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    `;
                    appliedCoupons.appendChild(item);
                });
                document.querySelectorAll('.remove-coupon').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = parseInt(this.dataset.index);
                        appliedCouponsList.splice(idx, 1);
                        renderAppliedCoupons();
                        updateOrderSummary();
                    });
                });
            }

            // Order Summary
            function updateOrderSummary() {
                let subtotal = 0;
                const rows = productsContainer.querySelectorAll('.product-row');
                rows.forEach(row => {
                    subtotal += calculateRowTotal(row);
                });

                let discount = 0;
                let couponNameUsed = '';
                appliedCouponsList.forEach(coupon => {
                    if (coupon.productId) {
                        const row = Array.from(rows).find(r => {
                            const productId = r.querySelector('.product-id-input').value;
                            return productId === coupon.productId;
                        });
                        if (row) {
                            const price = parseFloat(row.querySelector('.product-price').value) || 0;
                            const qty = parseInt(row.querySelector('.product-qty').value) || 0;
                            let discountAmount = 0;
                            if (coupon.type === 'percent') {
                                discountAmount = (price * qty) * (coupon.value / 100);
                            } else {
                                discountAmount = coupon.value;
                            }
                            discount += discountAmount;
                        }
                    } else {
                        if (coupon.type === 'percent') {
                            discount += subtotal * (coupon.value / 100);
                        } else {
                            discount += coupon.value;
                        }
                    }
                    couponNameUsed = coupon.name || coupon.id;
                });

                let walletUsed = 0;
                if (applyWallet.checked) {
                    walletUsed = subtotal * 0.1;
                    const walletBalance = parseFloat(customerWallet.value) || 0;
                    if (walletUsed > walletBalance) walletUsed = walletBalance;
                }

                let orderExtra = parseFloat(orderExtraAmount.value) || 0;
                let orderExtraApplied = orderExtraType.value === '+' ? orderExtra : -orderExtra;

                let deliveryCharge = parseFloat(deliveryAmountInput.value) || 0;

                subtotalAmount.textContent = `₹${subtotal.toFixed(2)}`;
                deliveryAmount.textContent = `₹${deliveryCharge.toFixed(2)}`;

                if (discount > 0) {
                    discountRow.style.display = 'flex';
                    discountAmount.textContent = `-₹${discount.toFixed(2)}`;
                } else {
                    discountRow.style.display = 'none';
                }
                if (appliedCouponsList.length > 0 && couponNameUsed) {
                    couponNameRow.style.display = 'flex';
                    couponNameDisplay.textContent = couponNameUsed;
                } else {
                    couponNameRow.style.display = 'none';
                }
                if (walletUsed > 0) {
                    walletRow.style.display = 'flex';
                    walletAmount.textContent = `-₹${walletUsed.toFixed(2)}`;
                } else {
                    walletRow.style.display = 'none';
                }
                const total = subtotal + deliveryCharge + orderExtraApplied - discount - walletUsed;
                totalAmount.textContent = `₹${total.toFixed(2)}`;
            }

            applyWallet.addEventListener('change', updateOrderSummary);
            deliveryAmountInput.addEventListener('input', updateOrderSummary);
            orderExtraAmount.addEventListener('input', updateOrderSummary);
            orderExtraType.addEventListener('change', updateOrderSummary);

            // Rebuild Product Codes from all orders and update products
            function rebuildProductCodes() {
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                const allProducts = JSON.parse(localStorage.getItem('products')) || [];
                const pcodes = JSON.parse(localStorage.getItem('pcodes')) || {};

                // First, update product sales and extra amounts from orders
                orders.forEach(order => {
                    order.products.forEach(product => {
                        if (!pcodes[product.id]) {
                            pcodes[product.id] = {
                                name: product.name,
                                totalSales: 0,
                                totalRevenue: 0,
                                totalLoss: 0,
                                orders: [],
                                coupons: [],
                                extraAmounts: []
                            };
                        }

                        // Calculate loss if needed
                        const originalProduct = allProducts.find(p => p.code === product.id);
                        let loss = 0;
                        if (originalProduct) {
                            const sellingPrice = parseFloat(originalProduct.sellingPrice) || 0;
                            const actualPrice = parseFloat(product.price) || 0;
                            if (actualPrice < sellingPrice) {
                                loss = (sellingPrice - actualPrice) * product.qty;
                            }
                        }

                        // Update sales data
                        pcodes[product.id].totalSales += product.qty;
                        pcodes[product.id].totalRevenue += product.total;
                        pcodes[product.id].totalLoss += loss;

                        // Add order details
                        pcodes[product.id].orders.push({
                            orderId: order.id,
                            date: order.date,
                            qty: product.qty,
                            price: product.price,
                            total: product.total,
                            extra: product.extra || 0,
                            extraReason: product.extraReason || '',
                            loss: loss,
                            customer: order.customer.name,
                            mobile: order.customer.mobile,
                            deliveryType: product.deliveryType || 'RK',
                            deliveryPrice: product.deliveryPrice || 0,
                            deliveryReason: product.deliveryReason || ''
                        });

                        // Add order-based extra amount if present
                        if (product.extra && product.extra !== 0) {
                            pcodes[product.id].extraAmounts.push({
                                type: 'order',
                                orderId: order.id,
                                date: order.date,
                                amount: product.extra,
                                reason: product.extraReason || 'Order extra',
                                customer: order.customer.name,
                                mobile: order.customer.mobile
                            });
                        }
                    });

                    // Handle coupons
                    if (order.coupons) {
                        order.coupons.forEach(coupon => {
                            if (coupon.productId && pcodes[coupon.productId]) {
                                pcodes[coupon.productId].coupons.push({
                                    orderId: order.id,
                                    date: order.date,
                                    couponName: coupon.name,
                                    couponValue: coupon.value,
                                    couponType: coupon.type,
                                    customer: order.customer.name,
                                    mobile: order.customer.mobile
                                });
                            }
                        });
                    }
                });

                // Second, update the main products data with the aggregated sales
                const updatedProducts = allProducts.map(product => {
                    if (pcodes[product.code]) {
                        return {
                            ...product,
                            totalSales: pcodes[product.code].totalSales,
                            totalProfits: (product.marginAmount * pcodes[product.code].totalSales) + 
                                          (product.extraAmounts ? product.extraAmounts.reduce((total, item) => {
                                              return item.type === 'credit' ? total + item.amount : total - item.amount;
                                          }, 0) : 0)
                        };
                    }
                    return product;
                });

                localStorage.setItem('products', JSON.stringify(updatedProducts));
                localStorage.setItem('pcodes', JSON.stringify(pcodes));
            }

            // Save Order
            orderForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!customerName.value.trim()) {
                    showNotification('Please enter customer name', false);
                    return;
                }
                if (!customerAddress.value.trim()) {
                    showNotification('Please enter customer address', false);
                    return;
                }
                const productRows = productsContainer.querySelectorAll('.product-row');
                if (productRows.length === 0) {
                    showNotification('Please add at least one product', false);
                    return;
                }
                const order = {
                    id: editingOrderId || currentOrderId,
                    date: new Date().toISOString(),
                    customer: {
                        mobile: customerMobile.value.trim(),
                        insta: customerInsta.value.trim(),
                        name: customerName.value.trim(),
                        email: customerEmail.value.trim(),
                        address: customerAddress.value.trim()
                    },
                    products: [],
                    subtotal: parseFloat(subtotalAmount.textContent.replace('₹', '')),
                    delivery: parseFloat(deliveryAmount.textContent.replace('₹', '')),
                    discount: discountRow.style.display === 'none' ? 0 : parseFloat(discountAmount.textContent.replace('-₹', '')),
                    couponName: couponNameDisplay.textContent,
                    walletUsed: walletRow.style.display === 'none' ? 0 : parseFloat(walletAmount.textContent.replace('-₹', '')),
                    orderExtra: parseFloat(orderExtraAmount.value) || 0,
                    orderExtraType: orderExtraType.value,
                    total: parseFloat(totalAmount.textContent.replace('₹', '')),
                    status: 'Making',
                    coupons: [...appliedCouponsList]
                };
                productRows.forEach(row => {
                    const productId = row.querySelector('.product-id-input').value;
                    const productName = row.querySelector('.product-name').value;
                    const productPrice = parseFloat(row.querySelector('.product-price').value) || 0;
                    const qty = parseInt(row.querySelector('.product-qty').value) || 0;
                    const deliveryType = row.querySelector('.delivery-type-select').value;
                    const deliveryPrice = parseFloat(row.querySelector('.delivery-price').value) || 0;
                    const deliveryReason = row.querySelector('.delivery-reason').value.trim();
                    const extra = parseFloat(row.querySelector('.product-extra').value) || 0;
                    const extraType = row.querySelector('.product-extra-type').value;
                    const extraReason = row.querySelector('.extra-reason').value.trim();
                    const extraApplied = extraType === '+' ? extra : -extra;
                    if (productId && qty > 0) {
                        order.products.push({
                            id: productId,
                            name: productName,
                            price: productPrice,
                            qty: qty,
                            deliveryType: deliveryType,
                            deliveryPrice: deliveryPrice,
                            deliveryReason: deliveryReason,
                            extra: extraApplied,
                            extraReason: extraReason,
                            total: (productPrice * qty) + (deliveryPrice * qty) + extraApplied
                        });
                    }
                });
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                if (editingOrderId) {
                    orders = orders.map(o => (o.id === editingOrderId ? order : o));
                } else {
                    orders.push(order);
                }
                localStorage.setItem('orders', JSON.stringify(orders));
                updateCustomerData(order);
                rebuildProductCodes();
                showNotification(editingOrderId ? 'Order updated successfully!' : 'Order created successfully!');
                resetForm();
                orderFormContainer.classList.remove('show');
                loadOrders();
            });

            // Update customer data
            function updateCustomerData(order) {
                const customers = JSON.parse(localStorage.getItem('customers')) || [];
                const mobile = order.customer.mobile;
                const insta = order.customer.insta;
                let customerIndex = customers.findIndex(c =>
                    (mobile && c.mobile === mobile) ||
                    (insta && c.insta && c.insta.toLowerCase() === insta.toLowerCase())
                );
                if (customerIndex === -1) {
                    customers.push({
                        mobile: mobile,
                        insta: insta,
                        name: order.customer.name,
                        email: order.customer.email,
                        addresses: [order.customer.address],
                        walletBalance: 0,
                        orders: [order.id]
                    });
                } else {
                    if (!customers[customerIndex].orders) {
                        customers[customerIndex].orders = [];
                    }
                    if (!customers[customerIndex].orders.includes(order.id)) {
                        customers[customerIndex].orders.push(order.id);
                    }
                    if (!customers[customerIndex].addresses.includes(order.customer.address)) {
                        customers[customerIndex].addresses.push(order.customer.address);
                    }
                    if (order.walletUsed > 0) {
                        customers[customerIndex].walletBalance =
                            (customers[customerIndex].walletBalance || 0) - order.walletUsed;
                    }
                }
                localStorage.setItem('customers', JSON.stringify(customers));
            }

            // Reset Form
            function resetForm() {
                orderForm.reset();
                customerDetails.classList.add('hidden');
                productsContainer.innerHTML = '';
                appliedCoupons.innerHTML = '';
                appliedCouponsList = [];
                editingOrderId = null;
                generateOrderId();
                updateOrderSummary();
                couponUsedNotice.style.display = "none";
                updateCustomerDatalists();
            }

            // Load Orders
            function loadOrders() {
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                orderTableBody.innerHTML = '';
                if (orders.length === 0) {
                    noOrdersMessage.style.display = 'block';
                    return;
                }
                noOrdersMessage.style.display = 'none';
                orders.sort((a, b) => new Date(b.date) - new Date(a.date));
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    const date = new Date(order.date);
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                    let productsDisplay = '';
                    order.products.forEach(p => {
                        productsDisplay += `<div>${p.name} (${p.qty} x ₹${p.price.toFixed(2)}`;
                        if (p.deliveryType) productsDisplay += `, ${p.deliveryType}`;
                        if (p.extra) productsDisplay += `, Extra: ${p.extra >= 0 ? '+' : ''}${p.extra}`;
                        if (p.extraReason) productsDisplay += ` - ${p.extraReason}`;
                        productsDisplay += `)</div>`;
                    });
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${formattedDate}</td>
                        <td>${order.customer.name}</td>
                        <td>${order.customer.mobile || ''}</td>
                        <td>${productsDisplay}</td>
                        <td>₹${order.subtotal.toFixed(2)}</td>
                        <td>₹${order.delivery.toFixed(2)}</td>
                        <td>₹${order.discount.toFixed(2)}</td>
                        <td>${order.couponName || '-'}</td>
                        <td>₹${order.walletUsed.toFixed(2)}</td>
                        <td>₹${order.total.toFixed(2)}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order.id}', this.value)">
                                <option value="Making" ${order.status === 'Making' ? 'selected' : ''}>Making</option>
                                <option value="Dispatched" ${order.status === 'Dispatched' ? 'selected' : ''}>Dispatched</option>
                                <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>
    <i class="fas fa-edit edit-icon action-icon" onclick="editOrder('${order.id}')"></i>
    <i class="fas fa-trash delete-icon action-icon" onclick="deleteOrder('${order.id}')"></i>
    <i class="fas fa-file-download action-icon" style="color:#4CAF50;"
       onclick="downloadBill('${order.id}')" title="Download Bill"></i>
</td>

                    `;
                    orderTableBody.appendChild(row);
                });
            }

            // Global functions
            window.editOrder = function(orderId) {
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                const order = orders.find(o => o.id === orderId);
                if (!order) return;
                editingOrderId = orderId;
                orderFormContainer.classList.add('show');
                orderIdDisplay.textContent = order.id;
                customerMobile.value = order.customer.mobile || '';
                customerInsta.value = order.customer.insta || '';
                autoFillCustomer();
                customerName.value = order.customer.name;
                customerEmail.value = order.customer.email;
                customerAddress.value = order.customer.address;
                customerWallet.value = (currentCustomer && currentCustomer.walletBalance) || 0;
                productsContainer.innerHTML = '';
                order.products.forEach(p => addProductRow({
                    id: p.id,
                    name: p.name,
                    price: p.price,
                    qty: p.qty,
                    deliveryType: p.deliveryType,
                    deliveryPrice: p.deliveryPrice,
                    deliveryReason: p.deliveryReason,
                    extra: p.extra,
                    extraReason: p.extraReason
                }));
                appliedCouponsList = order.coupons || [];
                renderAppliedCoupons();
                couponNameDisplay.textContent = order.couponName || '';
                orderExtraAmount.value = order.orderExtra || 0;
                orderExtraType.value = order.orderExtraType || '+';
                deliveryAmountInput.value = order.delivery || 0;
                updateOrderSummary();
            };

            window.deleteOrder = function(orderId) {
                if (confirm('Are you sure you want to delete this order?')) {
                    let orders = JSON.parse(localStorage.getItem('orders')) || [];
                    orders = orders.filter(o => o.id !== orderId);
                    localStorage.setItem('orders', JSON.stringify(orders));
                    rebuildProductCodes();
                    loadOrders();
                    showNotification('Order deleted successfully!');
                }
            };

            window.updateOrderStatus = function(orderId, status) {
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                orders = orders.map(o => o.id === orderId ? { ...o, status } : o);
                localStorage.setItem('orders', JSON.stringify(orders));
                rebuildProductCodes();
                loadOrders();
                showNotification('Order status updated!');
            };

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = orderTableBody.querySelectorAll('tr');
                let hasResults = false;
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                        hasResults = true;
                    } else {
                        row.style.display = 'none';
                    }
                });
                searchXBtn.style.display = searchTerm.length ? 'block' : 'none';
                noOrdersMessage.style.display = hasResults || searchTerm === '' ? 'none' : 'block';
                noOrdersMessage.textContent = 'No orders found matching your search.';
            });

            searchXBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
                searchInput.focus();
            });

            showFormBtn.addEventListener('click', function() {
                orderFormContainer.classList.add('show');
                generateOrderId();
                resetForm();
            });

            formCloseBtn.addEventListener('click', function() {
                orderFormContainer.classList.remove('show');
                resetForm();
            });
            // Initial Load
            generateOrderId();
            loadOrders();
            updateCustomerDatalists();
            updateProductIdsDatalist();
            updateOrderSummary();
            rebuildProductCodes();
        });
// -------------------- FINAL PERFECT BILL DOWNLOAD --------------------

async function downloadBill(orderId) {

    const orders = JSON.parse(localStorage.getItem("orders")) || [];
    const order = orders.find(o => o.id === orderId);

    if (!order) {
        alert("Order not found!");
        return;
    }

    const billHTML = `
<div id="bill-export" style="
    width:1587px !important;
    min-width:1587px !important;
    max-width:1587px !important;
    margin:0;
    background:#fff5eb;
    font-family:'Josefin Sans', sans-serif;
    position:relative;
">

    <!-- TOP IMAGE (full, no cut) -->
    <img src="above.png" style="width:100%;height:auto;display:block;">

    <!-- BORDER WRAPPER (between top & bottom) -->
    <div style="
        position:relative;
        width:100%;
        padding-left:111px;
        padding-right:111px;
    ">

        <!-- LEFT BORDER -->
        <div style="
            position:absolute;
            top:0;
            left:0;
            bottom:0;
            width:111px;                        /* FIXED */
            background:url('border.png') repeat-y top;
            background-size:111px auto;          /* NO STRETCH */
            image-rendering: crisp-edges;
        "></div>

        <!-- RIGHT BORDER -->
        <div style="
            position:absolute;
            top:0;
            right:0;
            bottom:0;
            width:111px;
            background:url('border.png') repeat-y top;
            background-size:111px auto;
            image-rendering: crisp-edges;
        "></div>

        <!-- MAIN CONTENT -->
        <div style="padding:60px;position:relative;z-index:10;">

            <!-- CUSTOMER INFO -->
            <div style="font-size:26.4px;line-height:2.07; ">
                <p><strong style="font-style: italic;">🧍‍♂️ Who’s the lucky human? (Name):</strong> ${order.customer.name}</p>
                <p><strong style="font-style: italic;">📞 Just in case we vibe later (Phone Number):</strong> ${order.customer.mobile}</p>


                <p><strong style="font-style: italic;">📍 Where do we pull up? (Delivery Address):</strong> <br><div style="font-size:26.4px;line-height:1.2;"> ${order.customer.address} </div></p>
           
            </div>

            <img src="line.png" style="width:100%;margin-top: 120px;
    margin-bottom: 0px;">

            <!-- PRODUCT TABLE -->
            <table style="width:100%;border-collapse:collapse;font-size:21px;line-height:1.35;margin:0;">
                <tr style="padding: 0px 10px;">
                   
    <td style="padding-bottom:6px;text-align:left;
        padding-left:27px;
        width:599.1px;
        max-width:599.1px;
        padding-right:127px;
        word-wrap:break-word;
        overflow-wrap:break-word;">🎁 What you snagged (Product):</td>

    <td style="padding-right:27px; text-align:left;">Qty</td>
    <td style="padding-right:27px; text-align:left;">Original Damage</td>
    <td style="padding-right:27px; text-align:left;">Steal Price</td>
    <td >Final Damage</td>

                </tr><tr>
    <td colspan="5" style="padding:0;margin:0;">
        <img src="line.png"
             style="width:100%;height:7px;display:block;margin:0;padding:0;">
    </td>
</tr>

                ${order.products.map((p, i) => `
                   <tr>

<td style="padding-top:30px; padding-left: 36px;  padding-right: 36px;">
    <div style="
        display:flex;
        align-items:flex-start;
    ">
        <div style="
            width:60px;
            flex-shrink:0;
            font-weight:600;
        ">
            ${i + 1}.
        </div>

        <div style="
            flex:1;
            white-space:normal;
            word-wrap:break-word;
            overflow-wrap:break-word;
        ">
            ${p.name}
        </div>
    </div>
</td>

                        <td style="padding-top: 30px; padding-right: 37px; text-align: right;">${p.qty}</td>
                        <td style="padding-top: 30px; padding-right: 54.6px; text-align: right;">₹${p.price}</td>
                        <td  style="padding-top: 30px; padding-right: 46px; text-align: right;">₹${p.deliveryPrice}</td>
                        <td style="padding-top: 30px; padding-right: 32.5px; text-align: right;">₹${p.total}</td>
                    </tr>
                `).join("")}
            </table>

            <img src="line.png" style="width:100%;margin:30px 0;">

            <div style="position:relative; margin-top:30px;">

    <!-- QR CODE (absolutely positioned, does NOT change height) -->
    <div id="qrBox" style="
        position:absolute;
        left:0;
        top:0;
        width:210px;
        height:210px;
        padding-left:27px;
        background:#fff5eb;
        border-radius:0px;
        z-index:20;
    "></div>
<!-- QR + LOGO OVERLAY WRAPPER -->
<div style="
    position: absolute;
    left: 27px;
    top: 0;
    width: 150px;
    height: 150px;
">

    <!-- QR CODE BOX -->
    <div id="qrBox" style="
        width: 210px;
        height: 210px;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;         /* QR always under logo */
        background: none;    /* never hide QR */
    "></div>

    <!-- LOGO CENTER OVER QR -->
    <img src="tp_logo.png" style="
        position:absolute;
        top:50%;
        left:50%;
        width:80px;
        height:auto;
        transform: translate(-50%, -50%);
        z-index: 20;         /* logo above QR */
        pointer-events: none;
    ">
</div>


<img src="scan.png" style="
    position:absolute;
    /* left:15px; */               /* same left alignment as QR box */
    top:162px;               /* QR(150px) + spacing(60px) → adjust if needed */
    width:210px;             /* exactly matches QR width */
    height:auto;
    z-index:22;
    display:block;
    object-fit:contain;
">

    <!-- TOTALS TABLE (aligned to the right, normal flow) -->
    <table style="
        font-size:21px;
        width:60%;
        margin-left:auto;
        margin-right:0;
        line-height:1.4;
    ">
        <tr><td>Damage Reduced:</td><td style="text-align:right;">₹${order.subtotal}</td></tr>
        <tr><td>Delivery:</td><td style="text-align:right;">₹${order.delivery}</td></tr>
        <tr><td>Discount:</td><td style="text-align:right;">₹${order.discount}</td></tr>
        <tr><td>Wallet Used:</td><td style="text-align:right;">₹${order.walletUsed}</td></tr>
        <tr><td><b>Total Amount:</b></td><td style="text-align:right;"><b>₹${order.total}</b></td></tr>
    </table>

</div>



          



        </div><!-- END MAIN CONTENT -->

    </div><!-- END BORDER WRAPPER -->

    <!-- BOTTOM IMAGE -->
    <img src="below.png" style="width:100%;height:auto;display:block;">

</div>
    `;

    // ---------------- FIXED BILL WRAPPER TO STOP SCREEN RESIZING ----------------
    const wrap = document.createElement("div");

    wrap.style.position = "fixed";
    wrap.style.top = "0";
    wrap.style.left = "0";
    wrap.style.width = "1587px";          // FIXED EXACT WIDTH
    wrap.style.zIndex = "999999";
    wrap.style.background = "#fff5eb";
    wrap.style.transform = "scale(1)";
    wrap.style.transformOrigin = "top left";

    wrap.innerHTML = billHTML;
    document.body.appendChild(wrap);
// Generate QR
const qrContainer = wrap.querySelector("#qrBox");
if (qrContainer) {


    const qrAmount = order.total;

    const upiUrl = `upi://pay?pa=trulypersonalized@axl&pn=TRY&am=${qrAmount}.00&cu=INR`;

    const qr = new QRCodeStyling({
        width: 150,
        height: 150,
        data: upiUrl,
        dotsOptions: {
            color: "#000",
            type: "rounded"
        },
        cornersSquareOptions: {
            type: "extra-rounded",
            color: "#000"
        },
        cornersDotOptions: {
            type: "dot",
            color: "#000"
        },
        backgroundOptions: {
            color: "#fff5eb"
        }
    });

    qr.append(qrContainer);
}


   // Convert to canvas






const element = wrap.querySelector("#bill-export");
const canvas = await html2canvas(element, { scale: 2 });
const imgData = canvas.toDataURL("image/png");

// DOWNLOAD PNG
const link = document.createElement("a");
link.download = `${order.id}_bill.png`;
link.href = imgData;
link.click();

wrap.remove();


}


    </script>
</body>
</html>
